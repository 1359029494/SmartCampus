<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<link href="../css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/repair.css"/>
		<link rel="stylesheet" type="text/css" href="../css/mui.poppicker.css" />
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.css" />
	</head>
	<style type="text/css">
		.mui-bar-nav{
			background: deepskyblue; height:40px;
			
		}
		.mui-title{
			color: white;
			font-size: 18px;
			line-height: 42px;
		}
		.mui-icon-left-nav{
			color: white;
		}
	</style>
	<body>
		<header class="mui-bar mui-bar-nav" style="background: deepskyblue; height:44px;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" style="color: #FFFFFF;">我要报修</h1>
		</header>
		<div class="mui-content">
			<div class="mui-content-padded" style="margin: 5px;">
				<form class="mui-input-group" style="height: 90vh;">
					<div class="mui-input-row">
						<label>姓名<span style="color: red; float: right; margin-right: 10px;">*</span></label>
						<input type="text" placeholder="请输入您的姓名">
					</div>
					<div class="mui-input-row">
						<label>联系方式<span style="color: red; float: right; margin-right: 10px;">*</span></label>
						<input type="text" placeholder="请输入您的联系方式">
					</div>
					<div class="mui-input-row">
						<label>宿舍<span style="color: red; float: right; margin-right: 10px;">*</span></label>
						<input type="text" placeholder="如:3#123">
					</div>
					<div class="mui-input-row">
						<label>报修类型<span style="color: red; float: right; margin-right: 10px;">*</span></label>
						<button id='showUserPicker' class="mui-btn mui-btn-block" type='button'>请选择报修类型...</button>
					</div>
					<div class="mui-input-row" style="overflow: hidden;height: 250px;">
						<div style="font-size: 16px; margin-left: 12px; margin-top: 10px;">上传图片</div>
						<div class="photo1">
							<img src="../images/jiahao.png" class="add-img" width="50%">
						</div>
						<div class="photo1">
							<img src="../images/jiahao.png" class="add-img" width="50%">
						</div>
						<div class="photo1">
							<img src="../images/jiahao.png" class="add-img" width="50%">
						</div>
					</div>
					<div class="mui-input-row" style="margin: 10px 5px; height: 80px;">
						<label style="font-size: 14px; margin-left: -5px; margin-top: -6px;">备注</label>
						<textarea id="textarea" rows="6"></textarea>
					</div>
					<div class="photo-div">
						<img src="" class="add-img">
					</div>
					<div class="photo-div">
						<img src="" class="add-img">
					</div>
					<div class="photo-div">
						<img src="" class="add-img">
					</div>
					<button type="button" id="submit-button" class="mui-btn mui-btn-primary">提交</button>
				</form>
			</div>
		</div>

		
		<script src="../js/mui.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/jquery-3.3.1.js"></script>
		<script src="../js/mui.previewimage.js"></script>
		<script src="../js/mui.zoom.js"></script>
		<script src="../js/mui.picker.js"></script>
		<script src="../js/mui.poppicker.js"></script>
		
		<script type="text/javascript">
			mui.init();
			(function($, doc) {
				$.init();
				$.ready(function() {
					//普通示例
					var userPicker = new $.PopPicker();
					userPicker.setData([{
						value: "宿舍设施损坏",
						text: "宿舍设施损坏"
					}, {
						value: '校园设施损坏',
						text: '校园设施损坏'
					}, {
						value: '教室设施损坏',
						text: '教室设施损坏'
					}]);
					var showUserPickerButton = doc.getElementById('showUserPicker');
					// var userResult = doc.getElementById('userResult');
					showUserPickerButton.addEventListener('tap', function(event) {
						userPicker.show(function(items) {
							//userResult.innerText = JSON.stringify(items[0]);
							console.log(items[0].text)
							document.getElementById('showUserPicker').innerHTML = items[0].text
							//返回 false 可以阻止选择框的关闭
							//return false;
						});
					}, false);
				})
			})(mui, document);
			
			var task = null
			var files = []; //图片存放的数组 可以上传一个，或者多个图片 
			var sub = $('#submit-button').get(0)
			 
			
			
			
			var photo = document.getElementsByClassName('add-img')
			var thises = null
			for (var i = 0; i < photo.length; i++) {
				photo[i].addEventListener('tap', function() {
					thises = $(this).parent('.photo1')
					if (files.length < 3) { //判断当前图片个数
						var btnArray = [{
							title: "打开照相机"
						}, {
							title: "打开相册"
						}]; //选择按钮  1 2 3
						plus.nativeUI.actionSheet({
								title: "请选择",
								cancel: "取消", // 0
								buttons: btnArray
							},
							function(e) {
								var index = e.index; //
								//alert(index);
								switch (index) {
									case 1:
										//写自己的逻辑
										camera(thises);
										break;
									case 2:
										xiangce(thises);
										break;
								}
							})
					} else {
						mui.alert('最多只能选取3张图片')
					}
				})
			}
			 
			//提交
			sub.addEventListener('tap', function() {
				var details = document.getElementById('details').value
				if (details === null || details === '') {
					mui.alert('不要忘记分享你的新鲜事哦', '提示')
					return
				}
			
				start_upload(details);
			})
			
			function camera(element) {
				var cmr = plus.camera.getCamera();
				cmr.captureImage(function(p) {
					//成功
					plus.io.resolveLocalFileSystemURL(p, function(entry) {
						img_name = entry.name; //获得图片名称
						img_src = entry.toLocalURL(); //获得图片路径
						//var url1=document.getElementById('img');
						//url1.src=img_path;
						var temp = '<img src="' + img_src + '" class="load-img" data-preview-src="" data-preview-group="1">'
						$(element).html(temp)
						upload_img(img_src);
					}, function(e) {
						console.log("读取拍照文件错误：" + e.message);
					});
			
				}, function(e) {
					console.log("失败：" + e.message);
				}, {
					filename: '_doc/camera/',
					index: 1
				});
			}
			
			function xiangce(element) {
				plus.gallery.pick(function(path) {
					for (var i in path.files) {
						var fileSrc = path.files[i]
						var temp = ''
						temp = '<img src="' + fileSrc + '" class="load-img" data-preview-src="" data-preview-group="1">'
						$(element).html(temp)
						upload_img(fileSrc);
					}
			
				}, function(e) {
					console.log("取消选择图片");
				}, {
					filter: "image",
					multiple: true,
					maximum: 1,
					system: false,
					onmaxed: function() {
						plus.nativeUI.alert('每次最多只能选择1张图片');
					}
				});
			}
			
			//上传图片
			function upload_img(p) {
				//又初始化了一下文件数组 为了支持单个上传,如果你要一次上传多个，就不要在写这一行了
				//注意 
				//files=[];
				var n = p.substr(p.lastIndexOf('/') + 1);
				files.push({
					name: "name" + files.length,
					path: p
				});
			}
			//开始上传
			function start_upload(details) {
				if (files.length <= 0) {
					plus.nativeUI.alert("没有添加上传文件！");
					return;
				}
				//原生的转圈等待框
				var wt = plus.nativeUI.showWaiting();
			
				task = plus.uploader.createUpload(url + 'insletter.do', {
						method: "POST"
					},
					function(t, status) { //上传完成
						if (status == 200) {
							mui.toast('上传成功')
							//关闭转圈等待框
							wt.close();
							var loginx = {
								LogOut: function(callback) {
									//do something
									//callback
									callback && callback()
								}
							}
							loginx.LogOut(function() {
								if (mui.os.ios || mui.os.ipad || mui.os.iphone) {
									// 获取所有Webview窗口
									var curr = plus.webview.currentWebview();
									var wvs = plus.webview.all();
									for (var i = 0, len = wvs.length; i < len; i++) {
										//关闭除setting页面外的其他页面
										if (wvs[i].getURL() == curr.getURL())
											continue;
										plus.webview.close(wvs[i]);
									}
									//打开login页面后再关闭setting页面
									plus.webview.open('tab_footer.html');
									curr.close();
								} else
									plus.runtime.quit();
							})
						} else {
							console.log("上传失败：" + status);
							//关闭原生的转圈等待框
							wt.close();
						}
					});
			
				task.addData("details", details); //可以向后台传值
				task.addData("uid", getUid());
				for (var i = 0; i < files.length; i++) {
					var f = files[i];
					task.addFile(f.path, {
						key: f.name
					});
				}
				task.start();
			
			}
			
			// 产生一个随机数
			function getUid() {
				return Math.floor(Math.random() * 100000000 + 10000000).toString();
			}
			
			
			
			
			
			
			
			
			
			/* document.getElementById("photo-button").addEventListener("tap",function() {
				getImage();
			});
			document.getElementById("btn").addEventListener("tap",function() {
				var li=document.getElementsByTagName("li");
				alert(li.length); 
			}); 
			
			var i=1,gentry=null,w=null;
			var hl=null,le=null,de=null,ie=null;
			var unv=true;
			var bUpdated=false; //用于兼容可能提前注入导致DOM未解析完更新的问题
			// H5 plus事件处理
			function plusReady(){
				// 获取摄像头目录对象
				plus.io.resolveLocalFileSystemURL('_doc/', function(entry){
					entry.getDirectory('camera', {create:true}, function(dir){
						gentry = dir;
					}, function(e){
						outSet('Get directory "camera" failed: '+e.message);
					} );
				}, function(e){
					outSet('Resolve "_doc/" failed: '+e.message);
				});
			}
			if(window.plus){
				plusReady();
			}else{
				document.addEventListener('plusready', plusReady, false);
			}
			// 监听DOMContentLoaded事件
			document.addEventListener('DOMContentLoaded', function(){
				// 获取DOM元素对象
				hl=document.getElementById('history');
				le=document.getElementById('empty');
				de=document.getElementById('display');
				if(ie=document.getElementById('index')){
					ie.onchange=indexChanged;
				}
				// 判断是否支持video标签
				unv=!document.createElement('video').canPlayType;
			},false );
			function changeIndex(){
				outSet('选择摄像头：');
				ie.focus();
			}
			function indexChanged(){
				de.innerText = ie.options[ie.selectedIndex].innerText;
				i = parseInt(ie.value);
				outLine(de.innerText);
			}
			
			function getImage(){
				var cmr = plus.camera.getCamera();
				cmr.captureImage(function(p){
					outLine('成功：'+p);
					plus.io.resolveLocalFileSystemURL(p, function(entry){
						createItem(entry);
					}, function(e){
						outLine('读取拍照文件错误：'+e.message);
					});
				}, function(e){
					outLine('失败：'+e.message);
				}, {filename:'_doc/camera/',index:1});
			}
			
			// 显示文件
			function displayFile(li){
				if(w){
					outLine('重复点击！');
					return;
				}
				if(!li || !li.entry){
					ouSet('无效的媒体文件');
					return;
				}
				var name = li.entry.name;
				var suffix = name.substr(name.lastIndexOf('.'));
				var url = '';
				if(suffix=='.mov' || suffix=='.3gp' || suffix=='.mp4' || suffix=='.avi'){
					//if(unv){plus.runtime.openFile('_doc/camera/'+name);return;}
					url = '/plus/camera_video.html';
				} else {
					url = 'camera_image.html';
				}
				w=plus.webview.create(url,url,{hardwareAccelerated:true,scrollIndicator:'none',scalable:true,bounce:'all'});
				w.addEventListener('loaded', function(){
					w.evalJS('loadMedia("'+li.entry.toLocalURL()+'")');
					//w.evalJS('loadMedia("'+'http://localhost:13131/_doc/camera/'+name+'")');
				}, false );
				w.addEventListener('close', function(){
					w = null;
				}, false);
				w.show('pop-in');
			}
			
			// 添加播放项
			function createItem(entry){
				var li = document.createElement('li');
				li.className = 'ditem';
				li.innerHTML = '<span class="iplay"><font class="aname"></font><br/><font class="ainf"></font></span>';
				li.setAttribute('onclick', 'displayFile(this)' );
				hl.insertBefore( li, le.nextSibling );
				li.querySelector('.aname').innerText = entry.name;
				li.querySelector('.ainf').innerText = '...';
				li.entry = entry;
				// 设置空项不可见
				le.style.display = 'none';
			} */
			
			
			
		</script>
	</body>

</html>
